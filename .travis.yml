sudo: required

language: php
php:
- '7.1.9'

branches:
  only:
  - master

# travis runtime environment from here or settings. : https://docs.travis-ci.com/user/environment-variables/
env:
  global:
  - ZIP_FILE="php-$TRAVIS_BUILD_NUMBER-$TRAVIS_COMMIT.zip"

  # travis-ci secure doc : https://docs.travis-ci.com/user/encryption-keys/
  # before install travis , first install ruby & gem
  # $ gem install travis
  # $ travis encrypt SOMEVAR="secretvalue"

  # AWS_ACCESS_KEY_ID_DEV
  - secure: ""
  # AWS_SECRET_ACCESS_KEY_DEV
  - secure: ""
  # AWS_ACCESS_KEY_ID_STG
  - secure: ""
  # AWS_SECRET_ACCESS_KEY_STG
  - secure: ""
  # AWS_ACCESS_KEY_ID_PROD , value : AKI....QMQ
  - secure: "mRYIGKu29amD+nzOuA6fOUu/0QfCVD9Ewulj1dXRZbKivRSM1y6ZvD7ifyF4rfHwkqGTxCZ9/Zpz1WdqVJeASUwNjYJYyp9dNYyJRUrStnPj6GLI3uPa/qKBcGyT1OoUNQXpi4yqD7h4QH/U88JDYtGc1kEOGA2ATyFvltKe8e3zFHuYv7y7ZTUhkkihd1WZTdCXyIIpvP4Mu8+emUATm0llxW9ov3BOu7HE0s9zurxGW/BO+c1ZvoKKXzY1htML7ov28PRBzq8uC0SV3OUYt1n2vNLwiXhPQ1jSU0gY3W1D+aNXktDCMPxcmlAyscGtGV/REYOPJOIRHXm5XxdPawT/lZI1ZiiSfmMjpcgJ0vm1s445HHS73wdP2xJtUycROxxs1dp8dOTGreIgs3+6Nw1yf+E5+WJDqE+AzhmnO7VMlOO5/0ZaKFq6P9viAaWXaXmkAu6jNlHHWUyrq2KM2Gf2u0fkS+wHXxdRrI8dqMgSVyjQyEK+6SYJ0WEZs0MCy6TwKwDTdQbNEksDP/KdYlBVAkiluECSnE1kcDzBTeQqaaMGPHflAWjBvyJej0awEff0IrP+5mle3HYHCAPHySjrQ3//NJaLuAYRxyGqe7sy/KvmOyHPiT8OsjbD1gTgubJsR2HyX2h8aeBbjM8E/+j4UKPU8BmoTROaAtY1cHs="
  # AWS_SECRET_ACCESS_KEY_PROD
  - secure: "KtH44lTf408/yfaJYeL3i/noBi+dHUgDp7LYh/Eqs4xWe42KPBdXL1aK45b7XNOf36vOLKKTNujQQKyybvxEq/v3wmW/Ois8IHpB7DMoSNLbgnH4+zMz/wsFSyOk3Wu8+au17+B835A6PgJ0L7iD4hjCV7KT2HKLkgcVuvbxFLOkH6H145Yr8zcAo1X/1QKqUwpBfthZhiOxPWju841OFgj7kxuALHzoj0EbYHlRvUOHMUr/Mmtd/kIIoywuy81kWnP/idH6AYYnF/3mvEMZW+vIABmPbXtf6g7Euqvw/Pg/zLzLz6XC3oUHmge0PpkT/s6xUyz7tKsEFMEgfV7Tjjr638UZBz9mBaCFiQqinzF2J63jE9fr4W4IEEVGFo21oRohwv9NVuUR4G/XthGHcEtE9xe/BngwhdXPvKF7AJk9qZfwtzAohLc123JguqxPifXIkRhe57Q9DUkhGh9BAE+b76GyvQdbd7Q/Xo+ehQYHnXLgcBiYdP2lG1nARwkqtrmbTW/b7yaUAJFrgHcA18t01ybQT3Enyy3qhCCkpB2GEhqeceXlsa1hkkhfqRhdMnOl1VB8f1p+kwxRR9Wn1kuz7tJtB+lDlUXLAVQrS2ZskupCIPKBYJHgAqiqyfoOGsolh2ddhE0kGA6C9fel6/5c3p/MqglbD1FHuqtOH7M="

  # global variables
  - AWS_ACCESS_KEY_ID=''
  - AWS_SECRET_ACCESS_KEY=''
  - AWS_REGION='ap-northeast-1'
  - CODEDEPLOY_APP_NAME=''
  - CODEDEPLOY_GROUP=''


# notification - https://docs.travis-ci.com/user/notifications
# notifications:
#   email:
#     recipients:
#       - one@example.com
#       - other@example.com
#     on_success: never # default: change
#     on_failure: always # default: always
# integration to slack , setup on slack travis-ci app
notifications:
  email:
    on_failure: always
    on_success: never
  slack:
    rooms:
    - secure: "T4+k/2bnCct7YBkVsZAJ7iV+ip73t1mTpKn60ImjOigwdvkg7EScy8+O/c90l8nGF9C/b6Q4PHR0DdU5ciniYvcB9w9R0KG+OH5u8BE9RlkNSezRKgNKqZUQAUIK8Zw8+HVQ65azT5zbPlGbXyKRRmtg94aZY1Jt91nZLE2ytKqaph6rLuSPN/ZhwsQ32zqjlI7+YbzzGQbYBAE0x5CzWzsmJaMOa8eYPAfXE/4cfKw7Yk+p9fh8LoGUrS5RuPLYqOgJjemUN6veohANrhjICJHenf74ea8OIbwBAaMk27D/0zm6WBW/L7z89ya0CotmQugb/6wI7zv2jFXXZtLUN3W5QNnLNhv/GleNaXFJva8K7Y/aP+Y7Euns0q+51aaivZ/QOjHT6eHbxRpsHKCK6sI96EgctkNOIpJiMTi9/zlMxPoNtzCw/7waPzcq/MjRTY+DdU7vLXxSxPCDm2DU2XW8Ac5pv9hlD6DaTOYLrk8y+wa9q2foEOOLsQLihYOU+zy8VucXVAvlTO9a4WlQbA2h2yohfQz3BIhGEYlmNbRyGMCg0tS/N3Ey4GfttZBZoB8TTueC8iMdYJqHU6PBrpoW6/EMoQ6ya2naWKdAD9NCX1VVWbQwWPsfJ1n6M0FJ6RCBcVm2xXdKi0r9uOit3Uj+zTVlk6qhEa/XWOmWqYE="

cache:
  directories:
  - $COMPOSER_CACHE_DIR
  - $HOME/.composer/cache




# build lifecycle - https://docs.travis-ci.com/user/customizing-the-build/
# (OPTIONAL) Install apt addons
# (OPTIONAL) Install cache components
# before_install
# install
# before_script
# script
# (OPTIONAL) before_cache (for cleaning up cache)
# after_success or after_failure
# (OPTIONAL) before_deploy
# (OPTIONAL) deploy
# (OPTIONAL) after_deploy
# after_script

# set -e : when error stop build.
before_install:
- set -e
- echo `date +"%Y-%m-%d %H:%M:%S"`
- echo $TRAVIS_BRANCH
- if [[ $TRAVIS_BRANCH == "dev" ]]; then
    AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_DEV;
    AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_DEV;
    S3_BUCKET='';
    CODEDEPLOY_APP='';
    CODEDEPLOY_GROUP='';
  fi
- if [[ $TRAVIS_BRANCH == "staging" ]]; then
    AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_STG;
    AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_STG;
    S3_BUCKET='';
    CODEDEPLOY_APP='';
    CODEDEPLOY_GROUP='';
  fi
- if [[ $TRAVIS_BRANCH == "master" ]]; then
    AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PROD;
    AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PROD;
    S3_BUCKET='afgsfhdyur5joi868682333';
    CODEDEPLOY_APP='a1-EC2-CodeDeploy';
    CODEDEPLOY_GROUP='ec2';
  fi


# put testing scripts here
script:
- echo 'script step...'

before_deploy:
- cd "$TRAVIS_BUILD_DIR";
  mkdir "$TRAVIS_BUILD_DIR/zip";
  zip -r "$TRAVIS_BUILD_DIR/zip/$ZIP_FILE" *


deploy:
- provider: S3
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  region: $AWS_REGION
  local_dir: $TRAVIS_BUILD_DIR/zip
  bucket: $S3_BUCKET
  skip_cleanup: true
  on:
    all_branches: true

- provider: codedeploy
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  region: $AWS_REGION
  bucket: $S3_BUCKET
  key: $ZIP_FILE
  bundle_type: zip
  application: $CODEDEPLOY_APP
  deployment_group: $CODEDEPLOY_GROUP
  wait_until_deployed: true
  on:
    all_branches: true
